{"version":3,"file":"json-patch-duplex.min.js","sources":["../src/json-patch-duplex.js"],"names":["jsonpatch","escapePathComponent","str","indexOf","replace","_getPathRecursive","root","obj","found","key","hasOwnProperty","getPath","path","Error","getMirror","i","ilen","beforeDict","length","getObserverFromMirror","mirror","callback","j","jlen","observers","observer","removeObserverFromMirror","splice","unobserve","generate","Object","observe","_unobserve","clearTimeout","next","patches","Mirror","push","arr","_observe","a","alen","name","_isArray","object","type","observeOps","call","value","JSON","parse","stringify","intervals","this","currentInterval","dirtyCheck","fastCheck","setTimeout","slowCheck","window","addEventListener","attachEvent","ObserverInfo","v","deliverChangeRecords","_generate","temp","newKeys","_objectKeys","oldKeys","changed","deleted","t","oldVal","newVal","op","apply","tree","patch","result","p","plen","keys","split","len","index","parseInt","arrOps","objOps","compare","tree1","tree2","add","remove","move","from","copy","test","_get","delete","update","o","Array","isArray","exports"],"mappings":"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","sourcesContent":["/*!\r\n* json-patch-duplex.js 0.3.7\r\n* (c) 2013 Joachim Wester\r\n* MIT license\r\n*/\r\n\r\nvar jsonpatch;\r\n(function (jsonpatch) {\r\n    /* We use a Javascript hash to store each\r\n    function. Each hash entry (property) uses\r\n    the operation identifiers specified in rfc6902.\r\n    In this way, we can map each patch operation\r\n    to its dedicated function in efficient way.\r\n    */\r\n    /* The operations applicable to an object */\r\n    var objOps = {\r\n        add: function (obj, key) {\r\n            obj[key] = this.value;\r\n            return true;\r\n        },\r\n        remove: function (obj, key) {\r\n            delete obj[key];\r\n            return true;\r\n        },\r\n        replace: function (obj, key) {\r\n            obj[key] = this.value;\r\n            return true;\r\n        },\r\n        move: function (obj, key, tree) {\r\n            var temp = { op: \"_get\", path: this.from };\r\n            apply(tree, [temp]);\r\n            apply(tree, [\r\n                { op: \"remove\", path: this.from }\r\n            ]);\r\n            apply(tree, [\r\n                { op: \"add\", path: this.path, value: temp.value }\r\n            ]);\r\n            return true;\r\n        },\r\n        copy: function (obj, key, tree) {\r\n            var temp = { op: \"_get\", path: this.from };\r\n            apply(tree, [temp]);\r\n            apply(tree, [\r\n                { op: \"add\", path: this.path, value: temp.value }\r\n            ]);\r\n            return true;\r\n        },\r\n        test: function (obj, key) {\r\n            return (JSON.stringify(obj[key]) === JSON.stringify(this.value));\r\n        },\r\n        _get: function (obj, key) {\r\n            this.value = obj[key];\r\n        }\r\n    };\r\n\r\n    /* The operations applicable to an array. Many are the same as for the object */\r\n    var arrOps = {\r\n        add: function (arr, i) {\r\n            arr.splice(i, 0, this.value);\r\n            return true;\r\n        },\r\n        remove: function (arr, i) {\r\n            arr.splice(i, 1);\r\n            return true;\r\n        },\r\n        replace: function (arr, i) {\r\n            arr[i] = this.value;\r\n            return true;\r\n        },\r\n        move: objOps.move,\r\n        copy: objOps.copy,\r\n        test: objOps.test,\r\n        _get: objOps._get\r\n    };\r\n\r\n    var observeOps = {\r\n        add: function (patches, path) {\r\n            var patch = {\r\n                op: \"add\",\r\n                path: path + escapePathComponent(this.name),\r\n                value: this.object[this.name] };\r\n            patches.push(patch);\r\n        },\r\n        'delete': function (patches, path) {\r\n            var patch = {\r\n                op: \"remove\",\r\n                path: path + escapePathComponent(this.name)\r\n            };\r\n            patches.push(patch);\r\n        },\r\n        update: function (patches, path) {\r\n            var patch = {\r\n                op: \"replace\",\r\n                path: path + escapePathComponent(this.name),\r\n                value: this.object[this.name]\r\n            };\r\n            patches.push(patch);\r\n        }\r\n    };\r\n\r\n    function escapePathComponent(str) {\r\n        if (str.indexOf('/') === -1 && str.indexOf('~') === -1)\r\n            return str;\r\n        return str.replace(/~/g, '~0').replace(/\\//g, '~1');\r\n    }\r\n\r\n    function _getPathRecursive(root, obj) {\r\n        var found;\r\n        for (var key in root) {\r\n            if (root.hasOwnProperty(key)) {\r\n                if (root[key] === obj) {\r\n                    return escapePathComponent(key) + '/';\r\n                } else if (typeof root[key] === 'object') {\r\n                    found = _getPathRecursive(root[key], obj);\r\n                    if (found != '') {\r\n                        return escapePathComponent(key) + '/' + found;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return '';\r\n    }\r\n\r\n    function getPath(root, obj) {\r\n        if (root === obj) {\r\n            return '/';\r\n        }\r\n        var path = _getPathRecursive(root, obj);\r\n        if (path === '') {\r\n            throw new Error(\"Object not found in root\");\r\n        }\r\n        return '/' + path;\r\n    }\r\n\r\n    var beforeDict = [];\r\n\r\n    jsonpatch.intervals;\r\n\r\n    var Mirror = (function () {\r\n        function Mirror(obj) {\r\n            this.observers = [];\r\n            this.obj = obj;\r\n        }\r\n        return Mirror;\r\n    })();\r\n\r\n    var ObserverInfo = (function () {\r\n        function ObserverInfo(callback, observer) {\r\n            this.callback = callback;\r\n            this.observer = observer;\r\n        }\r\n        return ObserverInfo;\r\n    })();\r\n\r\n    function getMirror(obj) {\r\n        for (var i = 0, ilen = beforeDict.length; i < ilen; i++) {\r\n            if (beforeDict[i].obj === obj) {\r\n                return beforeDict[i];\r\n            }\r\n        }\r\n    }\r\n\r\n    function getObserverFromMirror(mirror, callback) {\r\n        for (var j = 0, jlen = mirror.observers.length; j < jlen; j++) {\r\n            if (mirror.observers[j].callback === callback) {\r\n                return mirror.observers[j].observer;\r\n            }\r\n        }\r\n    }\r\n\r\n    function removeObserverFromMirror(mirror, observer) {\r\n        for (var j = 0, jlen = mirror.observers.length; j < jlen; j++) {\r\n            if (mirror.observers[j].observer === observer) {\r\n                mirror.observers.splice(j, 1);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    function unobserve(root, observer) {\r\n        generate(observer);\r\n        if (Object.observe) {\r\n            _unobserve(observer, root);\r\n        } else {\r\n            clearTimeout(observer.next);\r\n        }\r\n\r\n        var mirror = getMirror(root);\r\n        removeObserverFromMirror(mirror, observer);\r\n    }\r\n    jsonpatch.unobserve = unobserve;\r\n\r\n    function observe(obj, callback) {\r\n        var patches = [];\r\n        var root = obj;\r\n        var observer;\r\n        var mirror = getMirror(obj);\r\n\r\n        if (!mirror) {\r\n            mirror = new Mirror(obj);\r\n            beforeDict.push(mirror);\r\n        } else {\r\n            observer = getObserverFromMirror(mirror, callback);\r\n        }\r\n\r\n        if (observer) {\r\n            return observer;\r\n        }\r\n\r\n        if (Object.observe) {\r\n            observer = function (arr) {\r\n                //This \"refresh\" is needed to begin observing new object properties\r\n                _unobserve(observer, obj);\r\n                _observe(observer, obj);\r\n\r\n                var a = 0, alen = arr.length;\r\n                while (a < alen) {\r\n                    if (!(arr[a].name === 'length' && _isArray(arr[a].object)) && !(arr[a].name === '__Jasmine_been_here_before__')) {\r\n                        var type = arr[a].type;\r\n\r\n                        switch (type) {\r\n                            case 'new':\r\n                                type = 'add';\r\n                                break;\r\n\r\n                            case 'deleted':\r\n                                type = 'delete';\r\n                                break;\r\n\r\n                            case 'updated':\r\n                                type = 'update';\r\n                                break;\r\n                        }\r\n\r\n                        observeOps[type].call(arr[a], patches, getPath(root, arr[a].object));\r\n                    }\r\n                    a++;\r\n                }\r\n\r\n                if (patches) {\r\n                    if (callback) {\r\n                        callback(patches);\r\n                    }\r\n                }\r\n                observer.patches = patches;\r\n                patches = [];\r\n            };\r\n        } else {\r\n            observer = {};\r\n\r\n            mirror.value = JSON.parse(JSON.stringify(obj)); // Faster than ES5 clone - http://jsperf.com/deep-cloning-of-objects/5\r\n\r\n            if (callback) {\r\n                //callbacks.push(callback); this has no purpose\r\n                observer.callback = callback;\r\n                observer.next = null;\r\n                var intervals = this.intervals || [100, 1000, 10000, 60000];\r\n                if (intervals.push === void 0) {\r\n                    throw new Error(\"jsonpatch.intervals must be an array\");\r\n                }\r\n                var currentInterval = 0;\r\n\r\n                var dirtyCheck = function () {\r\n                    generate(observer);\r\n                };\r\n                var fastCheck = function () {\r\n                    clearTimeout(observer.next);\r\n                    observer.next = setTimeout(function () {\r\n                        dirtyCheck();\r\n                        currentInterval = 0;\r\n                        observer.next = setTimeout(slowCheck, intervals[currentInterval++]);\r\n                    }, 0);\r\n                };\r\n                var slowCheck = function () {\r\n                    dirtyCheck();\r\n                    if (currentInterval == intervals.length)\r\n                        currentInterval = intervals.length - 1;\r\n                    observer.next = setTimeout(slowCheck, intervals[currentInterval++]);\r\n                };\r\n                if (typeof window !== 'undefined') {\r\n                    if (window.addEventListener) {\r\n                        window.addEventListener('mousedown', fastCheck);\r\n                        window.addEventListener('mouseup', fastCheck);\r\n                        window.addEventListener('keydown', fastCheck);\r\n                    } else {\r\n                        window.attachEvent('onmousedown', fastCheck);\r\n                        window.attachEvent('onmouseup', fastCheck);\r\n                        window.attachEvent('onkeydown', fastCheck);\r\n                    }\r\n                }\r\n                observer.next = setTimeout(slowCheck, intervals[currentInterval++]);\r\n            }\r\n        }\r\n        observer.patches = patches;\r\n        observer.object = obj;\r\n\r\n        mirror.observers.push(new ObserverInfo(callback, observer));\r\n\r\n        return _observe(observer, obj);\r\n    }\r\n    jsonpatch.observe = observe;\r\n\r\n    /// Listen to changes on an object tree, accumulate patches\r\n    function _observe(observer, obj) {\r\n        if (Object.observe) {\r\n            Object.observe(obj, observer);\r\n            for (var key in obj) {\r\n                if (obj.hasOwnProperty(key)) {\r\n                    var v = obj[key];\r\n                    if (v && typeof (v) === \"object\") {\r\n                        _observe(observer, v);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return observer;\r\n    }\r\n\r\n    function _unobserve(observer, obj) {\r\n        if (Object.observe) {\r\n            Object.unobserve(obj, observer);\r\n            for (var key in obj) {\r\n                if (obj.hasOwnProperty(key)) {\r\n                    var v = obj[key];\r\n                    if (v && typeof (v) === \"object\") {\r\n                        _unobserve(observer, v);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return observer;\r\n    }\r\n\r\n    function generate(observer) {\r\n        if (Object.observe) {\r\n            Object.deliverChangeRecords(observer);\r\n        } else {\r\n            var mirror;\r\n            for (var i = 0, ilen = beforeDict.length; i < ilen; i++) {\r\n                if (beforeDict[i].obj === observer.object) {\r\n                    mirror = beforeDict[i];\r\n                    break;\r\n                }\r\n            }\r\n            _generate(mirror.value, observer.object, observer.patches, \"\");\r\n        }\r\n        var temp = observer.patches;\r\n        if (temp.length > 0) {\r\n            observer.patches = [];\r\n            if (observer.callback) {\r\n                observer.callback(temp);\r\n            }\r\n        }\r\n        return temp;\r\n    }\r\n    jsonpatch.generate = generate;\r\n\r\n    var _objectKeys;\r\n    if (Object.keys) {\r\n        _objectKeys = Object.keys;\r\n    } else {\r\n        _objectKeys = function (obj) {\r\n            var keys = [];\r\n            for (var o in obj) {\r\n                if (obj.hasOwnProperty(o)) {\r\n                    keys.push(o);\r\n                }\r\n            }\r\n            return keys;\r\n        };\r\n    }\r\n\r\n    // Dirty check if obj is different from mirror, generate patches and update mirror\r\n    function _generate(mirror, obj, patches, path) {\r\n        var newKeys = _objectKeys(obj);\r\n        var oldKeys = _objectKeys(mirror);\r\n        var changed = false;\r\n        var deleted = false;\r\n\r\n        for (var t = oldKeys.length - 1; t >= 0; t--) {\r\n            var key = oldKeys[t];\r\n            var oldVal = mirror[key];\r\n            if (obj.hasOwnProperty(key)) {\r\n                var newVal = obj[key];\r\n                if (oldVal instanceof Object) {\r\n                    _generate(oldVal, newVal, patches, path + \"/\" + escapePathComponent(key));\r\n                } else {\r\n                    if (oldVal != newVal) {\r\n                        changed = true;\r\n                        patches.push({ op: \"replace\", path: path + \"/\" + escapePathComponent(key), value: newVal });\r\n                        mirror[key] = newVal;\r\n                    }\r\n                }\r\n            } else {\r\n                patches.push({ op: \"remove\", path: path + \"/\" + escapePathComponent(key) });\r\n                delete mirror[key];\r\n                deleted = true; // property has been deleted\r\n            }\r\n        }\r\n\r\n        if (!deleted && newKeys.length == oldKeys.length) {\r\n            return;\r\n        }\r\n\r\n        for (var t = 0; t < newKeys.length; t++) {\r\n            var key = newKeys[t];\r\n            if (!mirror.hasOwnProperty(key)) {\r\n                patches.push({ op: \"add\", path: path + \"/\" + escapePathComponent(key), value: obj[key] });\r\n                mirror[key] = JSON.parse(JSON.stringify(obj[key]));\r\n            }\r\n        }\r\n    }\r\n\r\n    var _isArray;\r\n    if (Array.isArray) {\r\n        _isArray = Array.isArray;\r\n    } else {\r\n        _isArray = function (obj) {\r\n            return obj.push && typeof obj.length === 'number';\r\n        };\r\n    }\r\n\r\n    /// Apply a json-patch operation on an object tree\r\n    function apply(tree, patches) {\r\n        var result = false, p = 0, plen = patches.length, patch;\r\n        while (p < plen) {\r\n            patch = patches[p];\r\n\r\n            // Find the object\r\n            var keys = patch.path.split('/');\r\n            var obj = tree;\r\n            var t = 1;\r\n            var len = keys.length;\r\n            while (true) {\r\n                if (_isArray(obj)) {\r\n                    var index = parseInt(keys[t], 10);\r\n                    t++;\r\n                    if (t >= len) {\r\n                        result = arrOps[patch.op].call(patch, obj, index, tree); // Apply patch\r\n                        break;\r\n                    }\r\n                    obj = obj[index];\r\n                } else {\r\n                    var key = keys[t];\r\n                    if (key.indexOf('~') != -1)\r\n                        key = key.replace(/~1/g, '/').replace(/~0/g, '~'); // escape chars\r\n                    t++;\r\n                    if (t >= len) {\r\n                        result = objOps[patch.op].call(patch, obj, key, tree); // Apply patch\r\n                        break;\r\n                    }\r\n                    obj = obj[key];\r\n                }\r\n            }\r\n            p++;\r\n        }\r\n        return result;\r\n    }\r\n    jsonpatch.apply = apply;\r\n\r\n    function compare(tree1, tree2) {\r\n        var patches = [];\r\n        _generate(tree1, tree2, patches, '');\r\n        return patches;\r\n    }\r\n    jsonpatch.compare = compare;\r\n})(jsonpatch || (jsonpatch = {}));\r\n\r\nif (typeof exports !== \"undefined\") {\r\n    exports.apply = jsonpatch.apply;\r\n    exports.observe = jsonpatch.observe;\r\n    exports.unobserve = jsonpatch.unobserve;\r\n    exports.generate = jsonpatch.generate;\r\n}\r\n"]}